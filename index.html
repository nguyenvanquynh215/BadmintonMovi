<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Qu·ªπ C·∫ßu L√¥ng (Auto Sync v10)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --green: #27ae60; --red: #c0392b; --bg: #f4f6f7; --blue: #2980b9; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 10px; background: var(--bg); font-size: 13px; }
        .grid { display: flex; gap: 15px; height: 96vh; }
        .col-left { width: 68%; display: flex; flex-direction: column; gap: 10px; }
        .col-right { width: 32%; background: white; padding: 10px; border-left: 3px solid #ddd; display: flex; flex-direction: column; overflow-y: auto; }
        .box { background: white; padding: 10px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #ddd; display: flex; flex-direction: column; }
        .box-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        h3, h4 { margin: 0; color: var(--primary); font-size: 16px; }
        .table-wrap { overflow: auto; flex: 1; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #eee; padding: 5px; text-align: center; white-space: nowrap; }
        th { background: var(--primary); color: white; position: sticky; top: 0; z-index: 10; font-size: 12px; }
        td input { width: 100%; border: none; background: transparent; text-align: center; font-family: inherit; }
        td input:focus { background: #f0f8ff; outline: 1px solid #ccc; }
        .col-fit { width: 1%; white-space: nowrap; text-align: left; font-weight: bold; }
        .money-cell { text-align: right; }
        .debt-cell { color: var(--red); font-weight: bold; }
        button { cursor: pointer; padding: 5px 10px; border: none; border-radius: 4px; color: white; font-weight: bold; font-size: 12px; }
        .btn-add { background: #3498db; }
        .btn-save { background: var(--green); width: 100%; margin-top: 10px; padding: 10px; font-size: 14px; }
        .btn-del { background: var(--red); padding: 2px 6px; font-size: 10px; color: white; margin-left: 4px; }
        .btn-capture { background: var(--green); margin-top: 10px; width: 100%; padding: 8px; }
        .icon-btn { background: none; color: var(--red); font-size: 14px; padding: 0; margin-right: 5px; }
        .btn-sm { padding: 2px 5px; font-size: 10px; margin-left: 5px; background: #95a5a6; }
        .right-panel-section { margin-bottom: 15px; border-bottom: 1px dashed #ccc; padding-bottom: 10px; }
        .guest-input-group { display: flex; gap: 3px; background: #fff0f0; padding: 5px; border: 1px dashed red; margin-bottom: 5px; align-items: center; }
        .settings-table th { background: #7f8c8d; }
        .settings-table td input { text-align: center; width: 100%; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; }
        .modal-content { background: white; width: 350px; margin: 50px auto; padding: 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .form-row { margin-bottom: 12px; }
        .form-row label { display: block; font-weight: bold; margin-bottom: 4px; }
        .form-row input, .form-row select { width: 100%; padding: 6px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        .cal-ctrl { display: flex; justify-content: space-between; margin-bottom: 5px; background: #eee; padding: 3px; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; }
        .cal-cell { padding: 6px; background: #f9f9f9; cursor: pointer; text-align: center; border: 1px solid #eee; }
        .cal-cell:hover { background: #ddd; }
        .tabs { margin-bottom: 5px; display: flex; align-items: center; }
        .tab-btn { background: #ddd; color: #333; margin-right: 5px; padding: 8px 15px; }
        .tab-btn.active { background: var(--primary); color: white; }
        .tab-content { display: none; height: 100%; }
        .tab-content.active { display: block; }
        
        /* Cloud Status & Loading */
        .cloud-status { margin-left: auto; font-size: 11px; display: flex; align-items: center; gap: 5px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; display: inline-block; }
        .status-online { background: var(--green); }
        .status-offline { background: var(--red); }
        .btn-sync { background: var(--blue); color: white; margin-left: 10px; }
        .loading-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.9); z-index: 999; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--blue); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadingText" style="font-weight: bold; color: #2c3e50;">ƒêang k·∫øt n·ªëi GitHub...</div>
</div>

<div class="tabs">
    <button class="tab-btn active" onclick="switchTab('tab-tonghop')">T·ªïng H·ª£p</button>
    <button class="tab-btn" onclick="switchTab('tab-chi')">Qu·∫£n L√Ω Chi</button>
    
    <div class="cloud-status">
        <span id="statusDot" class="status-dot"></span>
        <span id="statusText">Ch∆∞a k·∫øt n·ªëi</span>
        <button class="btn-sync" onclick="openCloudConfig()">‚òÅÔ∏è C·∫•u h√¨nh GitHub</button>
        <button class="btn-sync" style="background: var(--green);" onclick="manualSync()">üîÑ L∆∞u & ƒê·ªìng B·ªô</button>
    </div>
</div>

<div id="tab-tonghop" class="tab-content active">
    <div class="grid">
        <div class="col-left">
            <div class="box" style="flex: 0 0 42%;">
                <div class="box-header"><h3>S·ªê D∆Ø QU·ª∏ (NƒÉm <span class="year-display"></span>)</h3></div>
                <div class="table-wrap"><table id="balanceTable"><thead><tr><th class="col-fit">Ph√¢n lo·∫°i</th><th>T1</th><th>T2</th><th>T3</th><th>T4</th><th>T5</th><th>T6</th><th>T7</th><th>T8</th><th>T9</th><th>T10</th><th>T11</th><th>T12</th></tr></thead><tbody id="balanceBody"></tbody></table></div>
            </div>
            <div class="box" style="flex: 1;">
                <div class="box-header">
                    <h3>T√åNH H√åNH ƒê√ìNG QU·ª∏</h3>
                    <div><button class="btn-add" onclick="openMemberModal()">+ Th√™m</button><select id="yearSelect" onchange="changeYear()" style="padding: 3px; margin-left: 5px; font-weight: bold;"></select></div>
                </div>
                <div class="table-wrap"><table id="memberTable"><thead><tr><th style="width: 30px;">STT</th><th class="col-fit">H·ªç T√™n</th><th>Lo·∫°i</th><th>T1</th><th>T2</th><th>T3</th><th>T4</th><th>T5</th><th>T6</th><th>T7</th><th>T8</th><th>T9</th><th>T10</th><th>T11</th><th>T12</th></tr></thead><tbody id="memberBody"></tbody></table></div>
            </div>
        </div>
        <div class="col-right" id="captureArea">
            <h3 style="text-align: center; border-bottom: 2px solid var(--primary); padding-bottom: 10px; margin-bottom: 10px;">B·∫¢NG THEO D√ïI</h3>
            <div class="right-panel-section">
                <h4>1. THEO D√ïI N·ª¢ & THU</h4>
                <div class="guest-input-group"><input type="text" id="gName" placeholder="T√™n kh√°ch..." style="width: 30%;"><input type="date" id="gDate" style="width: 35%; border: 1px solid #ccc; border-radius: 4px; padding: 3px;"><input type="text" id="gAmt" placeholder="Ti·ªÅn..." onkeyup="formatCurrency(this)" style="width: 25%;"><button class="btn-add" style="width: 10%; padding: 0;" onclick="addGuestDebt()">+</button></div>
                <table id="debtTable" style="margin-top: 5px;"></table>
            </div>
            <div class="right-panel-section" style="border: none;">
                <h4>2. C·∫§U H√åNH S√ÇN B√ÉI</h4>
                <table class="settings-table" style="margin-bottom: 10px;"><thead><tr><th colspan="3">B·∫£ng 1: S√¢n ƒê√°nh <button class="btn-sm" onclick="addCourtRow()">+ Th√™m s√¢n</button></th></tr><tr><th>T√™n S√¢n</th><th>Gi·ªù ƒê√°nh</th><th style="width: 30px;">X√≥a</th></tr></thead><tbody id="courtSettingBody"></tbody></table>
                <table class="settings-table"><thead><tr><th colspan="2">B·∫£ng 2: Ph√≠ ƒê√°nh (Quy ƒë·ªãnh)</th></tr><tr><th>Lo·∫°i</th><th>S·ªë Ti·ªÅn (VNƒê)</th></tr></thead><tbody><tr><td>C·ªë ƒê·ªãnh</td><td><input type="text" id="confFeeFixed" onkeyup="formatCurrency(this)" onchange="updateSettings()"></td></tr><tr><td>V√£ng Lai</td><td><input type="text" id="confFeeGuest" onkeyup="formatCurrency(this)" onchange="updateSettings()"></td></tr></tbody></table>
            </div>
            <button class="btn-capture" onclick="capture()">üì∏ CH·ª§P M√ÄN H√åNH</button>
        </div>
    </div>
</div>

<div id="tab-chi" class="tab-content">
    <div class="box" style="height: 90vh;">
        <div class="box-header"><h3>NH·∫¨T K√ù CHI TI√äU</h3><button class="btn-add" onclick="openExpenseModal()">+ Th√™m kho·∫£n chi</button></div>
        <div class="table-wrap"><table id="expenseTable"><thead><tr><th>Ng√†y Chi</th><th>Th√°ng (MM/YYYY)</th><th>N·ªôi dung</th><th>Chi ti·∫øt</th><th>S·ªë ti·ªÅn</th><th>H√†nh ƒë·ªông</th></tr></thead><tbody id="expenseBody"></tbody></table></div>
    </div>
</div>

<div id="memberModal" class="modal">
    <div class="modal-content"><span onclick="closeModal('memberModal')" style="float:right; cursor:pointer; font-size: 20px;">&times;</span><h3>Ghi Nh·∫≠n ƒê√≥ng Qu·ªπ</h3>
        <div class="form-row"><label>H·ªç t√™n:</label> <input type="text" id="mName"></div>
        <div class="form-row"><label>Lo·∫°i:</label> <select id="mType"><option value="C·ªë ƒê·ªãnh">C·ªë ƒê·ªãnh</option><option value="V√£ng Lai">V√£ng Lai</option></select></div>
        <div class="form-row"><label>S·ªë ti·ªÅn:</label> <input type="text" id="mAmount" onkeyup="formatCurrency(this)"></div>
        <div class="form-row"><label>Ng√†y ƒë√≥ng:</label><div style="border:1px solid #ddd; padding:5px;"><div class="cal-ctrl"><button onclick="calNav(-1)">&lt;</button> <span id="calLabel"></span> <button onclick="calNav(1)">&gt;</button></div><div id="calGrid" class="cal-grid"></div></div><input type="hidden" id="mDate"><div id="mDateDisplay" style="text-align:center; color:green; margin-top:5px;"></div></div>
        <button class="btn-save" onclick="saveMember()">L∆ØU</button>
    </div>
</div>
<div id="expenseModal" class="modal">
    <div class="modal-content"><span onclick="closeModal('expenseModal')" style="float:right; cursor:pointer; font-size: 20px;">&times;</span><h3>Th√™m Kho·∫£n Chi</h3>
        <div class="form-row"><label>Ng√†y:</label> <input type="date" id="exDate"></div>
        <div class="form-row"><label>Lo·∫°i:</label><select id="exType"><option value="Thu√™ S√¢n">Thu√™ S√¢n</option><option value="·ªêng c·∫ßu">·ªêng c·∫ßu</option><option value="N∆∞·ªõc">N∆∞·ªõc</option><option value="T·ªï ch·ª©c gi·∫£i">T·ªï ch·ª©c gi·∫£i</option><option value="Kh√°c">Kh√°c</option></select></div>
        <div class="form-row"><label>Chi ti·∫øt:</label> <input type="text" id="exDetail"></div>
        <div class="form-row"><label>Ti·ªÅn:</label> <input type="text" id="exAmount" onkeyup="formatCurrency(this)"></div>
        <button class="btn-save" onclick="saveExpense()">L∆ØU</button>
    </div>
</div>
<div id="cloudModal" class="modal">
    <div class="modal-content"><span onclick="closeModal('cloudModal')" style="float:right; cursor:pointer; font-size: 20px;">&times;</span><h3>C·∫•u H√¨nh GitHub Cloud</h3>
        <p style="font-size: 11px; color: #666;">Nh·∫≠p th√¥ng tin 1 l·∫ßn, tr√¨nh duy·ªát s·∫Ω t·ª± nh·ªõ.</p>
        <div class="form-row"><label>GitHub Username:</label> <input type="text" id="ghUser"></div>
        <div class="form-row"><label>Repository Name:</label> <input type="text" id="ghRepo"></div>
        <div class="form-row"><label>Personal Access Token:</label> <input type="password" id="ghToken"></div>
        <button class="btn-save" style="background: var(--blue);" onclick="saveCloudConfig()">L∆ØU & K·∫æT N·ªêI</button>
    </div>
</div>

<script>
    const START_YEAR = 2025;
    let currentYear = new Date().getFullYear();
    let viewYear = 2026; 

    // DATA DEFAULT
    const defaultSettings = { courts: [{ id: 1, name: "S√¢n 1", time: "18h - 20h" }], feeFixed: 200000, feeGuest: 50000 };
    const defaultData = { membersByYear: { 2026: [] }, sponsors: {}, expenses: [], guestDebts: [] };

    let settings = JSON.parse(JSON.stringify(defaultSettings));
    let data = JSON.parse(JSON.stringify(defaultData));
    
    // GITHUB CONFIG
    let ghConfig = { user: '', repo: '', token: '' };
    let fileSha = null;

    // --- INIT ---
    function init() {
        populateYearSelect();
        initCalendar();
        document.getElementById('gDate').valueAsDate = new Date();
        
        // CHECK LOCAL CONFIG IMMEDIATELY
        const conf = localStorage.getItem("GH_CONFIG");
        if(conf) {
            // Found config, try to fetch
            ghConfig = JSON.parse(conf);
            document.getElementById('ghUser').value = ghConfig.user;
            document.getElementById('ghRepo').value = ghConfig.repo;
            document.getElementById('ghToken').value = ghConfig.token;
            fetchFromGitHub();
        } else {
            // No config, show default
            renderAll();
            // Show config modal to prompt user
            setTimeout(() => { openCloudConfig(); alert("B·∫°n ch∆∞a c·∫•u h√¨nh GitHub! H√£y nh·∫≠p Token ƒë·ªÉ l∆∞u d·ªØ li·ªáu online."); }, 1000);
        }
    }

    function saveCloudConfig() {
        ghConfig.user = document.getElementById('ghUser').value.trim();
        ghConfig.repo = document.getElementById('ghRepo').value.trim();
        ghConfig.token = document.getElementById('ghToken').value.trim();
        
        if(!ghConfig.user || !ghConfig.repo || !ghConfig.token) return alert("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!");
        
        localStorage.setItem("GH_CONFIG", JSON.stringify(ghConfig));
        closeModal('cloudModal');
        fetchFromGitHub();
    }

    // Helper for UTF-8 Base64
    function utf8_to_b64(str) { return window.btoa(unescape(encodeURIComponent(str))); }
    function b64_to_utf8(str) { return decodeURIComponent(escape(window.atob(str))); }

    async function fetchFromGitHub() {
        showLoading(true, "ƒêang t·∫£i d·ªØ li·ªáu...");
        const url = `https://api.github.com/repos/${ghConfig.user}/${ghConfig.repo}/contents/data.json`;
        
        try {
            const response = await fetch(url, { headers: { 'Authorization': `token ${ghConfig.token}`, 'Accept': 'application/vnd.github.v3+json' } });

            if(response.status === 404) {
                console.log("File data.json ch∆∞a c√≥, s·∫Ω t·∫°o m·ªõi khi l∆∞u.");
                fileSha = null;
                updateStatusUI(true, "Online (File m·ªõi)");
            } else if(response.ok) {
                const json = await response.json();
                fileSha = json.sha;
                const content = b64_to_utf8(json.content);
                const parsed = JSON.parse(content);
                
                data = parsed.data || defaultData;
                settings = parsed.settings || defaultSettings;
                
                document.getElementById('confFeeFixed').value = formatNum(settings.feeFixed);
                document.getElementById('confFeeGuest').value = formatNum(settings.feeGuest);
                
                checkAndInitYearData(viewYear);
                renderAll();
                updateStatusUI(true, "ƒê√£ ƒë·ªìng b·ªô");
            } else {
                updateStatusUI(false);
                alert("L·ªói k·∫øt n·ªëi GitHub! Ki·ªÉm tra l·∫°i Token/Repo.");
            }
        } catch (error) {
            console.error(error);
            updateStatusUI(false);
        } finally {
            showLoading(false);
        }
    }

    async function manualSync() { await saveToGitHub(); }

    async function saveToGitHub() {
        if(!ghConfig.token) return alert("Ch∆∞a c·∫•u h√¨nh GitHub!");
        showLoading(true, "ƒêang l∆∞u l√™n Cloud...");
        const url = `https://api.github.com/repos/${ghConfig.user}/${ghConfig.repo}/contents/data.json`;
        const payload = {
            message: "Update data via Web App",
            content: utf8_to_b64(JSON.stringify({ data: data, settings: settings }, null, 2)),
            sha: fileSha
        };

        try {
            const response = await fetch(url, {
                method: 'PUT',
                headers: { 'Authorization': `token ${ghConfig.token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if(response.ok) {
                const json = await response.json();
                fileSha = json.content.sha;
                updateStatusUI(true, "ƒê√£ l∆∞u th√†nh c√¥ng");
            } else {
                const err = await response.json();
                alert("L·ªói khi l∆∞u: " + err.message);
            }
        } catch (error) {
            alert("L·ªói m·∫°ng khi l∆∞u d·ªØ li·ªáu!");
        } finally {
            showLoading(false);
        }
    }

    // --- LOGIC ---
    function checkAndInitYearData(year) {
        if (!data.membersByYear[year]) {
            data.membersByYear[year] = [];
            let prevYear = year - 1;
            while(prevYear >= START_YEAR) {
                if (data.membersByYear[prevYear] && data.membersByYear[prevYear].length > 0) {
                    data.membersByYear[year] = data.membersByYear[prevYear].map(m => ({ id: Date.now() + Math.random(), name: m.name, type: m.type, contributions: {} }));
                    saveToGitHub(); // Auto save structure
                    break;
                }
                prevYear--;
            }
        }
    }

    // ACTIONS Wrapper
    function performAction(actionFn) {
        actionFn();
        renderAll();
        // Debounce auto-save or manual? Let's auto-save for better UX
        // But to avoid API limit, maybe manual is safer? 
        // For now, let's keep it manual save or save on explicit Save buttons.
        // Uncomment below line for auto-save on every click (risk hitting API limits if spamming)
        // saveToGitHub(); 
    }

    function renderAll() { renderMembers(); renderBalanceTable(); renderExpenseTable(); renderCourtSettings(); renderDebtTable(); }

    // (C√°c h√†m render c≈© gi·ªØ nguy√™n)
    function renderMembers() {
        const tb = document.getElementById('memberBody'); tb.innerHTML = '';
        let currentMembers = data.membersByYear[viewYear] || [];
        currentMembers.forEach((mem, idx) => {
            let tr = `<tr><td>${idx+1}</td><td class="col-fit"><button class="icon-btn" onclick="deleteMember(${mem.id})">üóëÔ∏è</button>${mem.name}</td><td>${mem.type === 'C·ªë ƒê·ªãnh' ? 'Cƒê' : 'VL'}</td>`;
            for(let m=1; m<=12; m++) {
                let val = mem.contributions[`${viewYear}-${m}`];
                let display = (val !== undefined) ? formatNum(val) : '-';
                let delBtn = (val !== undefined) ? `<span class="btn-del" onclick="delContrib(${mem.id}, ${m})">x</span>` : '';
                tr += `<td>${display} ${delBtn}</td>`;
            }
            tb.innerHTML += tr + `</tr>`;
        });
    }

    function getBalanceAtEndOf(year, month) {
        let bal = 0;
        for(let y=START_YEAR; y<=year; y++) {
            let endM = (y===year) ? month : 12;
            let mems = data.membersByYear[y] || [];
            for(let m=1; m<=endM; m++) {
                mems.forEach(mem => bal += (mem.contributions[`${y}-${m}`]||0));
                bal += (data.sponsors[`${y}-${m}-company`]||0) + (data.sponsors[`${y}-${m}-union`]||0);
                data.expenses.forEach(e => { if(e.year===y && e.month===m) bal -= e.amount; });
            }
        }
        return bal;
    }

    function renderBalanceTable() {
        const tb = document.getElementById('balanceBody'); tb.innerHTML = '';
        let rows = { open: {n:"S·ªë d∆∞ ƒë·∫ßu k√¨", v:[]}, in_mem: {n:"- Th√†nh vi√™n", v:[]}, in_cp: {n:"- Cty t√†i tr·ª£", v:[], e:'company'}, in_un: {n:"- Cƒê t√†i tr·ª£", v:[], e:'union'}, out: {n:"Chi", v:[]}, close: {n:"S·ªë d∆∞ cu·ªëi k√¨", v:[]} };
        let currentMembers = data.membersByYear[viewYear] || [];
        for(let m=1; m<=12; m++) {
            let prev = (m===1) ? getBalanceAtEndOf(viewYear-1, 12) : getBalanceAtEndOf(viewYear, m-1);
            rows.open.v.push(prev);
            let sm=0; currentMembers.forEach(x => sm+=(x.contributions[`${viewYear}-${m}`]||0));
            rows.in_mem.v.push(sm);
            rows.in_cp.v.push(data.sponsors[`${viewYear}-${m}-company`]||0);
            rows.in_un.v.push(data.sponsors[`${viewYear}-${m}-union`]||0);
            let sout=0; data.expenses.forEach(e=>{if(e.year===viewYear && e.month===m) sout+=e.amount});
            rows.out.v.push(sout);
            rows.close.v.push(prev + sm + rows.in_cp.v[m-1] + rows.in_un.v[m-1] - sout);
        }
        const rowHTML = (o, bold=false) => {
            let h = `<tr><td class="col-fit" style="font-weight:${bold?'bold':'normal'}">${o.n}</td>`;
            o.v.forEach((v, i) => {
                let cell = o.e ? `<input type="text" value="${formatNum(v)}" onkeyup="formatCurrency(this)" onchange="saveSponsor('${o.e}', ${i+1}, this.value)">` : `<span style="color:${v<0?'red':'inherit'}">${formatNum(v)}</span>`;
                h += `<td class="money-cell">${cell}</td>`;
            });
            return h + '</tr>';
        };
        tb.innerHTML += rowHTML(rows.open) + rowHTML(rows.in_mem) + rowHTML(rows.in_cp) + rowHTML(rows.in_un) + rowHTML(rows.out) + rowHTML(rows.close, true);
    }

    function renderDebtTable() {
        const table = document.getElementById('debtTable');
        const today = new Date(); const currentM = today.getMonth() + 1;
        let maxM = (viewYear < currentYear) ? 12 : (viewYear > currentYear ? 0 : currentM);
        let debts = []; let currentMembers = data.membersByYear[viewYear] || [];
        currentMembers.forEach(mem => {
            if(mem.type === 'C·ªë ƒê·ªãnh') {
                let userDebts = [];
                for(let m=1; m<=maxM; m++) {
                    let paid = mem.contributions[`${viewYear}-${m}`] || 0;
                    if (paid < settings.feeFixed) userDebts.push({ display: `T${m}: ${formatNum(settings.feeFixed - paid)}`, isManual: false });
                }
                if(userDebts.length > 0) debts.push({ name: mem.name, items: userDebts });
            }
        });
        let guestMap = {};
        data.guestDebts.forEach((g, idx) => {
            if(g.year === viewYear) {
                if(!guestMap[g.name]) guestMap[g.name] = [];
                let dateDisplay = g.fullDate ? g.fullDate.split('-').reverse().join('/').substring(0,5) : `T${g.month}`;
                guestMap[g.name].push({ display: `${dateDisplay}: ${formatNum(g.amount)}`, isManual: true, id: idx });
            }
        });
        for(let k in guestMap) debts.push({ name: k + " (VL)", items: guestMap[k] });
        let maxCols = 0; debts.forEach(d => maxCols = Math.max(maxCols, d.items.length));
        if(maxCols === 0) { table.innerHTML = '<tr><td colspan="2">Kh√¥ng c√≥ c√¥ng n·ª£</td></tr>'; return; }
        let thead = `<thead><tr><th class="col-fit">H·ªç T√™n</th>`;
        for(let i=0; i<maxCols; i++) thead += `<th>Kho·∫£n n·ª£ ${i+1}</th>`;
        thead += `</tr></thead><tbody>`;
        let tbody = ``;
        debts.forEach(d => {
            tbody += `<tr><td class="col-fit">${d.name}</td>`;
            for(let i=0; i<maxCols; i++) {
                if(d.items[i]) {
                    let item = d.items[i];
                    let delBtn = item.isManual ? `<span class="btn-del" onclick="delGuestDebt(${item.id})">x</span>` : '';
                    tbody += `<td class="debt-cell">${item.display} ${delBtn}</td>`;
                } else { tbody += `<td></td>`; }
            }
            tbody += `</tr>`;
        });
        table.innerHTML = thead + tbody + `</tbody>`;
    }

    function renderCourtSettings() {
        const tb = document.getElementById('courtSettingBody'); tb.innerHTML = '';
        settings.courts.forEach((court, idx) => {
            tb.innerHTML += `<tr><td><input type="text" value="${court.name}" onchange="updateCourt(${idx}, 'name', this.value)"></td><td><input type="text" value="${court.time}" onchange="updateCourt(${idx}, 'time', this.value)"></td><td><button class="btn-del" onclick="removeCourt(${idx})">x</button></td></tr>`;
        });
    }

    function renderExpenseTable() {
        const tb = document.getElementById('expenseBody'); tb.innerHTML = '';
        data.expenses.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach((e, idx) => {
            let mStr = String(e.month).padStart(2,'0') + '/' + e.year;
            tb.innerHTML += `<tr><td>${e.date.split('-').reverse().join('/')}</td><td>${mStr}</td><td>${e.type}</td><td>${e.detail}</td><td class="money-cell">${formatNum(e.amount)}</td><td><button class="btn-del" onclick="delExpense(${idx})">X√≥a</button></td></tr>`;
        });
    }

    // ACTIONS
    function changeYear() { viewYear = parseInt(document.getElementById('yearSelect').value); checkAndInitYearData(viewYear); document.querySelectorAll('.year-display').forEach(e=>e.innerText=viewYear); renderAll(); }
    function addCourtRow() { performAction(() => settings.courts.push({ id: Date.now(), name: "S√¢n M·ªõi", time: "18h - 20h" })); }
    function removeCourt(index) { if(confirm("X√≥a s√¢n?")) performAction(() => settings.courts.splice(index, 1)); }
    function updateCourt(idx, f, v) { settings.courts[idx][f] = v; } // Only local update, wait for manual save
    function updateSettings() { settings.feeFixed = parseNum(document.getElementById('confFeeFixed').value); settings.feeGuest = parseNum(document.getElementById('confFeeGuest').value); renderDebtTable(); }
    function addGuestDebt() {
        let name = document.getElementById('gName').value, dateVal = document.getElementById('gDate').value, rawAmt = document.getElementById('gAmt').value;
        if(!name || rawAmt === '' || !dateVal) return alert("Thi·∫øu th√¥ng tin!");
        performAction(() => { data.guestDebts.push({ name: name, month: new Date(dateVal).getMonth()+1, year: new Date(dateVal).getFullYear(), fullDate: dateVal, amount: parseNum(rawAmt) }); document.getElementById('gName').value = ''; document.getElementById('gAmt').value = ''; });
    }
    function delGuestDebt(idx) { if(confirm("X√≥a n·ª£?")) performAction(() => data.guestDebts.splice(idx, 1)); }
    function saveMember() {
        let name = document.getElementById('mName').value, type = document.getElementById('mType').value, rawAmt = document.getElementById('mAmount').value, date = document.getElementById('mDate').value;
        if(!name || rawAmt === '' || !date) return alert("Thi·∫øu th√¥ng tin");
        let y = new Date(date).getFullYear(), m = new Date(date).getMonth()+1;
        checkAndInitYearData(y);
        performAction(() => {
            let mems = data.membersByYear[y], mem = mems.find(x=>x.name===name);
            if(!mem) { mem={id:Date.now(), name:name, type:type, contributions:{}}; mems.push(mem); }
            mem.type = type; mem.contributions[`${y}-${m}`] = (mem.contributions[`${y}-${m}`]||0) + parseNum(rawAmt);
            closeModal('memberModal');
        });
        saveToGitHub(); // Auto save for member actions
    }
    function saveSponsor(type, m, v) { data.sponsors[`${viewYear}-${m}-${type}`] = parseNum(v); renderBalanceTable(); saveToGitHub(); }
    function saveExpense() {
        let d = document.getElementById('exDate').value, rawAmt = document.getElementById('exAmount').value;
        if(!d || rawAmt === '') return;
        let dojb = new Date(d);
        performAction(() => { data.expenses.push({ date: d, month: dojb.getMonth()+1, year: dojb.getFullYear(), type: document.getElementById('exType').value, detail: document.getElementById('exDetail').value, amount: parseNum(rawAmt) }); closeModal('expenseModal'); });
        saveToGitHub();
    }
    function deleteMember(id) { if(confirm("X√≥a th√†nh vi√™n?")) { performAction(() => data.membersByYear[viewYear] = data.membersByYear[viewYear].filter(x=>x.id!==id)); saveToGitHub(); } }
    function delContrib(id, m) { if(confirm("X√≥a ƒë√≥ng qu·ªπ th√°ng "+m+"?")) { performAction(() => { let mem=data.membersByYear[viewYear].find(x=>x.id===id); if(mem) delete mem.contributions[`${viewYear}-${m}`]; }); saveToGitHub(); } }
    function delExpense(i) { if(confirm("X√≥a kho·∫£n chi?")) { performAction(() => data.expenses.splice(i,1)); saveToGitHub(); } }

    // UTILS
    function openMemberModal() { document.getElementById('memberModal').style.display = 'block'; resetCal(); }
    function openExpenseModal() { document.getElementById('expenseModal').style.display = 'block'; document.getElementById('exDate').valueAsDate = new Date(); }
    function openCloudConfig() { document.getElementById('cloudModal').style.display = 'block'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function populateYearSelect() { let s = document.getElementById('yearSelect'); s.innerHTML=''; for(let y=2025; y<=2099; y++) { let o=document.createElement('option'); o.value=y; o.text=y; if(y===viewYear) o.selected=true; s.add(o); } document.querySelectorAll('.year-display').forEach(e=>e.innerText=viewYear); }
    function formatCurrency(e) { let v = e.value.replace(/\D/g,''); if(v !== '') e.value = parseInt(v).toLocaleString('en-US'); else e.value = ''; }
    function formatNum(n) { return n.toLocaleString('en-US'); }
    function parseNum(s) { if(s===''||s==null) return 0; return parseInt(s.toString().replace(/,/g,''))||0; }
    function switchTab(id) { document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active')); document.getElementById(id).classList.add('active'); event.currentTarget.classList.add('active'); }
    function capture() { html2canvas(document.getElementById("captureArea")).then(c => { let l=document.createElement('a'); l.download='bao-cao.png'; l.href=c.toDataURL(); l.click(); }); }
    function updateStatusUI(connected, msg) {
        const dot = document.getElementById('statusDot'); const txt = document.getElementById('statusText');
        dot.className = connected ? "status-dot status-online" : "status-dot status-offline";
        txt.innerText = msg || (connected ? "Online" : "Ch∆∞a k·∫øt n·ªëi");
        txt.style.color = connected ? "green" : "red";
    }
    function showLoading(show, msg) {
        document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        if(msg) document.getElementById('loadingText').innerText = msg;
    }
    // Calendar (Simple)
    let calState = {m:1, y:2026};
    function initCalendar() { resetCal(); }
    function resetCal() { let n=new Date(); calState={m:n.getMonth()+1, y:n.getFullYear()}; renderCal(); }
    function renderCal() {
        let g=document.getElementById('calGrid'); g.innerHTML='';
        document.getElementById('calLabel').innerText = `${calState.m}/${calState.y}`;
        let dim = new Date(calState.y, calState.m, 0).getDate();
        let off = new Date(calState.y, calState.m-1, 1).getDay();
        for(let i=0; i<off; i++) g.appendChild(document.createElement('div'));
        for(let i=1; i<=dim; i++) {
            let d=document.createElement('div'); d.className='cal-cell'; d.innerText=i;
            d.onclick=()=>{ let s=`${calState.y}-${String(calState.m).padStart(2,'0')}-${String(i).padStart(2,'0')}`; document.getElementById('mDate').value=s; document.getElementById('mDateDisplay').innerText=s; };
            g.appendChild(d);
        }
    }
    function calNav(d) { calState.m+=d; if(calState.m>12){calState.m=1;calState.y++} if(calState.m<1){calState.m=12;calState.y--} renderCal(); }

    init();
</script>
</body>
</html>
